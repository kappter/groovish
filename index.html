<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bach Note Frequency Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .upload-area {
            border: 2px dashed #4ecdc4;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #ff6b6b;
            background: rgba(255, 255, 255, 0.1);
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
        }

        .analysis-container {
            display: none;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
        }

        .piano-roll {
            width: 100%;
            overflow-x: auto;
            background: #000;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .piano-keys {
            display: flex;
            flex-direction: column-reverse;
            width: 80px;
            position: sticky;
            left: 0;
            z-index: 10;
            background: #000;
        }

        .key {
            height: 20px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 10px;
            border-bottom: 1px solid #333;
        }

        .white-key {
            background: #fff;
            color: #000;
        }

        .black-key {
            background: #333;
            color: #fff;
        }

        .frequency-bars {
            display: flex;
            flex-direction: column-reverse;
            margin-left: 80px;
        }

        .frequency-bar {
            height: 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #333;
            position: relative;
        }

        .bar-fill {
            height: 16px;
            background: linear-gradient(90deg, #4ecdc4, #45b7d1, #ff6b6b);
            border-radius: 2px;
            transition: width 0.5s ease;
            margin: 2px 0;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4ecdc4;
        }

        .note-list {
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .key-analysis {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .key-result {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border-left: 4px solid #4ecdc4;
        }

        .key-result.best-match {
            border-left-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
        }

        .key-name {
            font-weight: bold;
            font-size: 1.1em;
        }

        .mode-info {
            font-size: 0.9em;
            color: #ccc;
        }

        .confidence-score {
            text-align: right;
            font-weight: bold;
            color: #4ecdc4;
        }

        .scale-notes {
            grid-column: 1 / -1;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 0.9em;
        }

        .note-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .note-match {
            display: inline-block;
            margin: 2px;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(78, 205, 196, 0.3);
        }

        .note-nomatch {
            display: inline-block;
            margin: 2px;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #4ecdc4;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Bach Note Frequency Analyzer</h1>
            <p>Upload a MIDI file to visualize note frequency in piano roll style</p>
        </div>

        <div class="upload-area" id="uploadArea">
            <div>
                <h3>Drop your MIDI file here or click to browse</h3>
                <p>Supports .mid and .midi files</p>
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    Choose File
                </button>
                <input type="file" id="fileInput" class="file-input" accept=".mid,.midi" onchange="handleFile(event)">
            </div>
        </div>

        <div id="analysisContainer" class="analysis-container">
            <div id="loadingDiv" class="loading">
                <div class="spinner"></div>
                <p>Analyzing MIDI file...</p>
            </div>
            
            <div id="resultsDiv" style="display: none;">
                <h2>Note Frequency Analysis</h2>
                
                <div class="piano-roll">
                    <div id="pianoVisualization"></div>
                </div>

                <div class="stats" id="statsContainer"></div>

                <div class="key-analysis" id="keyAnalysis" style="margin-bottom: 20px;">
                    <h3>Key and Mode Analysis</h3>
                    <div id="keyResults"></div>
                </div>

                <div class="note-list" id="noteList">
                    <h3>Detailed Note Frequencies</h3>
                    <div id="noteDetails"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Musical scales and modes
        const modes = {
            'Ionian (Major)': [0, 2, 4, 5, 7, 9, 11],
            'Dorian': [0, 2, 3, 5, 7, 9, 10],
            'Phrygian': [0, 1, 3, 5, 7, 8, 10],
            'Lydian': [0, 2, 4, 6, 7, 9, 11],
            'Mixolydian': [0, 2, 4, 5, 7, 9, 10],
            'Aeolian (Natural Minor)': [0, 2, 3, 5, 7, 8, 10],
            'Locrian': [0, 1, 3, 5, 6, 8, 10],
            'Harmonic Minor': [0, 2, 3, 5, 7, 8, 11],
            'Melodic Minor': [0, 2, 3, 5, 7, 9, 11]
        };

        const chromatic = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

        // MIDI note names and numbers
        const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        let noteFrequencies = {};
        let totalNotes = 0;

        // Drag and drop functionality
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#ff6b6b';
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#4ecdc4';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#4ecdc4';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processMidiFile(files[0]);
            }
        });

        function handleFile(event) {
            const file = event.target.files[0];
            if (file) {
                processMidiFile(file);
            }
        }

        function processMidiFile(file) {
            const analysisContainer = document.getElementById('analysisContainer');
            const loadingDiv = document.getElementById('loadingDiv');
            const resultsDiv = document.getElementById('resultsDiv');
            
            analysisContainer.style.display = 'block';
            loadingDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const arrayBuffer = e.target.result;
                    const midiData = parseMidi(arrayBuffer);
                    analyzeNotes(midiData);
                    analyzeKeyAndMode();
                    createVisualization();
                    
                    loadingDiv.style.display = 'none';
                    resultsDiv.style.display = 'block';
                } catch (error) {
                    console.error('Error parsing MIDI file:', error);
                    loadingDiv.innerHTML = '<p style="color: #ff6b6b;">Error: Could not parse MIDI file. Please ensure it\'s a valid MIDI file.</p>';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function parseMidi(arrayBuffer) {
            const view = new DataView(arrayBuffer);
            let offset = 0;
            
            // Simple MIDI parser - reads header and tracks
            const header = readMidiHeader(view, offset);
            offset += 14; // Header is 14 bytes
            
            const tracks = [];
            for (let i = 0; i < header.trackCount; i++) {
                const track = readMidiTrack(view, offset);
                tracks.push(track);
                offset += track.length + 8; // 8 bytes for track header
            }
            
            return { header, tracks };
        }

        function readMidiHeader(view, offset) {
            // Skip "MThd" (4 bytes) and length (4 bytes)
            const format = view.getUint16(offset + 8, false);
            const trackCount = view.getUint16(offset + 10, false);
            const ticksPerQuarter = view.getUint16(offset + 12, false);
            
            return { format, trackCount, ticksPerQuarter };
        }

        function readMidiTrack(view, offset) {
            // Skip "MTrk" (4 bytes)
            const length = view.getUint32(offset + 4, false);
            const events = [];
            
            let trackOffset = offset + 8;
            const trackEnd = trackOffset + length;
            let runningStatus = 0;
            
            while (trackOffset < trackEnd) {
                const deltaTime = readVariableLength(view, trackOffset);
                trackOffset += deltaTime.bytesRead;
                
                let status = view.getUint8(trackOffset);
                
                if (status < 0x80) {
                    // Running status
                    status = runningStatus;
                    trackOffset--; // Back up one byte
                } else {
                    runningStatus = status;
                }
                
                trackOffset++;
                
                if ((status & 0xF0) === 0x90) { // Note On
                    const note = view.getUint8(trackOffset);
                    const velocity = view.getUint8(trackOffset + 1);
                    events.push({ type: 'noteOn', note, velocity, deltaTime: deltaTime.value });
                    trackOffset += 2;
                } else if ((status & 0xF0) === 0x80) { // Note Off
                    const note = view.getUint8(trackOffset);
                    const velocity = view.getUint8(trackOffset + 1);
                    events.push({ type: 'noteOff', note, velocity, deltaTime: deltaTime.value });
                    trackOffset += 2;
                } else {
                    // Skip other events
                    if (status === 0xFF) { // Meta event
                        const type = view.getUint8(trackOffset);
                        const lengthInfo = readVariableLength(view, trackOffset + 1);
                        trackOffset += 1 + lengthInfo.bytesRead + lengthInfo.value;
                    } else if (status === 0xF0 || status === 0xF7) { // SysEx
                        const lengthInfo = readVariableLength(view, trackOffset);
                        trackOffset += lengthInfo.bytesRead + lengthInfo.value;
                    } else {
                        // Standard MIDI message
                        const messageLength = getMidiMessageLength(status);
                        trackOffset += messageLength - 1; // -1 because we already read the status
                    }
                }
            }
            
            return { events, length };
        }

        function readVariableLength(view, offset) {
            let value = 0;
            let bytesRead = 0;
            let byte;
            
            do {
                byte = view.getUint8(offset + bytesRead);
                value = (value << 7) | (byte & 0x7F);
                bytesRead++;
            } while ((byte & 0x80) && bytesRead < 4);
            
            return { value, bytesRead };
        }

        function getMidiMessageLength(status) {
            const type = status & 0xF0;
            switch (type) {
                case 0x80: case 0x90: case 0xA0: case 0xB0: case 0xE0:
                    return 3;
                case 0xC0: case 0xD0:
                    return 2;
                default:
                    return 1;
            }
        }

        function analyzeNotes(midiData) {
            noteFrequencies = {};
            totalNotes = 0;
            
            midiData.tracks.forEach(track => {
                track.events.forEach(event => {
                    if (event.type === 'noteOn' && event.velocity > 0) {
                        const noteName = getNoteName(event.note);
                        noteFrequencies[noteName] = (noteFrequencies[noteName] || 0) + 1;
                        totalNotes++;
                    }
                });
            });
        }

        function getNoteName(midiNote) {
            const octave = Math.floor(midiNote / 12) - 1;
            const noteName = noteNames[midiNote % 12];
            return `${noteName}${octave}`;
        }

        function createVisualization() {
            createPianoRoll();
            createStats();
            createKeyAnalysisDisplay();
            createNoteList();
        }

        function createPianoRoll() {
            const container = document.getElementById('pianoVisualization');
            container.innerHTML = '';
            
            const maxFrequency = Math.max(...Object.values(noteFrequencies));
            const pianoRange = 88; // Standard piano keys
            const startNote = 21; // A0
            
            let html = '<div style="display: flex;">';
            html += '<div class="piano-keys">';
            
            // Create piano keys
            for (let i = startNote + pianoRange - 1; i >= startNote; i--) {
                const noteName = getNoteName(i);
                const isBlackKey = noteNames[i % 12].includes('#');
                const keyClass = isBlackKey ? 'black-key' : 'white-key';
                html += `<div class="key ${keyClass}">${noteName}</div>`;
            }
            html += '</div>';
            
            html += '<div class="frequency-bars" style="flex: 1;">';
            
            // Create frequency bars
            for (let i = startNote + pianoRange - 1; i >= startNote; i--) {
                const noteName = getNoteName(i);
                const frequency = noteFrequencies[noteName] || 0;
                const percentage = maxFrequency > 0 ? (frequency / maxFrequency) * 100 : 0;
                
                html += `<div class="frequency-bar">`;
                html += `<div class="bar-fill" style="width: ${percentage}%"></div>`;
                if (frequency > 0) {
                    html += `<span style="position: absolute; right: 10px; font-size: 10px;">${frequency}</span>`;
                }
                html += `</div>`;
            }
            
            html += '</div></div>';
            container.innerHTML = html;
        }

        function analyzeKeyAndMode() {
            // Get note classes (ignore octaves) and their frequencies
            const noteClasses = {};
            Object.entries(noteFrequencies).forEach(([note, freq]) => {
                const noteClass = note.replace(/\d+$/, ''); // Remove octave number
                noteClasses[noteClass] = (noteClasses[noteClass] || 0) + freq;
            });

            const results = [];

            // Test each possible key and mode combination
            chromatic.forEach(root => {
                Object.entries(modes).forEach(([modeName, intervals]) => {
                    const scaleNotes = intervals.map(interval => {
                        const noteIndex = (chromatic.indexOf(root) + interval) % 12;
                        return chromatic[noteIndex];
                    });

                    const score = calculateKeyScore(noteClasses, scaleNotes);
                    results.push({
                        key: root,
                        mode: modeName,
                        scaleNotes,
                        score,
                        confidence: Math.round(score * 100)
                    });
                });
            });

            // Sort by score (best matches first)
            results.sort((a, b) => b.score - a.score);
            
            // Store top results
            window.keyAnalysisResults = results.slice(0, 8);
        }

        function calculateKeyScore(noteClasses, scaleNotes) {
            let totalFreq = Object.values(noteClasses).reduce((sum, freq) => sum + freq, 0);
            let scaleFreq = 0;
            let penalty = 0;

            // Calculate frequency of notes that are in the scale
            Object.entries(noteClasses).forEach(([note, freq]) => {
                if (scaleNotes.includes(note)) {
                    scaleFreq += freq;
                } else {
                    // Penalty for notes not in scale, but less harsh for enharmonic equivalents
                    const enharmonic = getEnharmonicEquivalent(note);
                    if (!scaleNotes.includes(enharmonic)) {
                        penalty += freq * 0.5; // Moderate penalty for chromatic notes
                    }
                }
            });

            // Score is the percentage of notes in scale, minus penalty
            let score = scaleFreq / totalFreq;
            score -= (penalty / totalFreq);
            
            // Bonus for having the tonic note prominent
            const tonic = scaleNotes[0];
            if (noteClasses[tonic]) {
                const tonicWeight = noteClasses[tonic] / totalFreq;
                score += tonicWeight * 0.2; // 20% bonus based on tonic prominence
            }

            return Math.max(0, Math.min(1, score)); // Clamp between 0 and 1
        }

        function getEnharmonicEquivalent(note) {
            const enharmonics = {
                'C#': 'Db', 'Db': 'C#',
                'D#': 'Eb', 'Eb': 'D#',
                'F#': 'Gb', 'Gb': 'F#',
                'G#': 'Ab', 'Ab': 'G#',
                'A#': 'Bb', 'Bb': 'A#'
            };
            return enharmonics[note] || note;
        }

        function createKeyAnalysisDisplay() {
            const container = document.getElementById('keyResults');
            const results = window.keyAnalysisResults || [];
            
            let html = '';
            
            results.forEach((result, index) => {
                const isTopResult = index === 0;
                const resultClass = isTopResult ? 'key-result best-match' : 'key-result';
                
                html += `
                    <div class="${resultClass}">
                        <div class="key-name">${result.key} ${result.mode}</div>
                        <div class="mode-info">${getModeDescription(result.mode)}</div>
                        <div class="confidence-score">${result.confidence}%</div>
                        <div class="scale-notes">
                            <strong>Scale notes:</strong> 
                            ${result.scaleNotes.map(note => {
                                const noteClasses = {};
                                Object.keys(noteFrequencies).forEach(n => {
                                    const noteClass = n.replace(/\d+$/, '');
                                    noteClasses[noteClass] = true;
                                });
                                const inPiece = noteClasses[note];
                                return `<span class="${inPiece ? 'note-match' : 'note-nomatch'}">${note}</span>`;
                            }).join(' ')}
                        </div>
                    </div>
                `;
            });
            
            if (results.length === 0) {
                html = '<p>No key analysis available. Please upload a MIDI file first.</p>';
            }
            
            container.innerHTML = html;
        }

        function getModeDescription(mode) {
            const descriptions = {
                'Ionian (Major)': 'Bright, happy, classical major scale',
                'Dorian': 'Minor with raised 6th - folk, medieval feel',
                'Phrygian': 'Dark, Spanish/Arabic flavor',
                'Lydian': 'Dreamy, ethereal with raised 4th',
                'Mixolydian': 'Bluesy, rock - major with flat 7th',
                'Aeolian (Natural Minor)': 'Sad, melancholic natural minor',
                'Locrian': 'Unstable, diminished - rarely used',
                'Harmonic Minor': 'Exotic, classical minor with leading tone',
                'Melodic Minor': 'Classical ascending minor scale'
            };
            return descriptions[mode] || 'Modal scale';
        }

        function createStats() {
            const container = document.getElementById('statsContainer');
            const uniqueNotes = Object.keys(noteFrequencies).length;
            const mostFrequentNote = Object.keys(noteFrequencies).reduce((a, b) => 
                noteFrequencies[a] > noteFrequencies[b] ? a : b, '');
            const averageFrequency = totalNotes / uniqueNotes || 0;
            
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${totalNotes}</div>
                    <div>Total Notes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${uniqueNotes}</div>
                    <div>Unique Notes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${mostFrequentNote}</div>
                    <div>Most Frequent</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${averageFrequency.toFixed(1)}</div>
                    <div>Average Frequency</div>
                </div>
            `;
        }

        function createNoteList() {
            const container = document.getElementById('noteDetails');
            const sortedNotes = Object.entries(noteFrequencies)
                .sort((a, b) => b[1] - a[1]);
            
            let html = '';
            sortedNotes.forEach(([note, frequency]) => {
                const percentage = ((frequency / totalNotes) * 100).toFixed(1);
                html += `
                    <div class="note-item">
                        <span>${note}</span>
                        <span>${frequency} times (${percentage}%)</span>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
    </script>
</body>
</html>